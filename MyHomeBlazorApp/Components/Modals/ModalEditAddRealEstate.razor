@using MyHome.Models;
@using MyHome;
@using MyHomeBlazorApp.Pages
@using System.ComponentModel.DataAnnotations
@inject BlazorData.DataService DataService

<style>
    .btn-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    }

    .left-buttons button,
    .right-buttons button {
    margin: 0 5px;
    }
</style>

<Modal @ref="refModalEditAddRealEstate" Title="Edit Real Estate Details">
    <BodyTemplate>
        <EditForm id="realEstateForm123" method="get" Model="CurrentRealEstate" OnSubmit="@RealEsatateFormSubmitted">
            <DataAnnotationsValidator />
            <div class="form-group row">
                <label for="realEstateName" class="col-sm-4 col-form-label">
                    Real Estate Name
                </label>
                <div class="col-sm-8">
                    <InputText id="realEstateName" class="form-control" placeholder="Real Estate Name"
                    @bind-Value="CurrentRealEstate.RealEstateName" />

                </div>

            </div>
            <AddressComponent CurrentObjectAddress="@CurrentRealEstate.Address" DisplaySubmitButton="false" />
            <ValidationSummary />

            <div class="btn-row mt-3">
                <div class="left-buttons">
                    @if (CurrentRealEstate.RealEstateID != 0)
                    {
                        @if (CurrentRealEstate.RealEstateID != _realEstatesListAsQueryable.First().RealEstateID && CurrentRealEstate.RealEstateID != 0)
                        {
                            <ButtonPreviuosNext ButtonEvent="OnModalRealEstatePreviuos" ButtonName="Previuos"  />
                        }
                        else
                        {
                            <ButtonPreviuosNext ButtonEvent="OnModalRealEstatePreviuos" ButtonName="Previuos" Disabled="true" />
                        }
                        @if (CurrentRealEstate.RealEstateID != _realEstatesListAsQueryable.Last().RealEstateID && CurrentRealEstate.RealEstateID != 0)
                        {
                            <ButtonPreviuosNext ButtonEvent="OnModalRealEstateNext" ButtonName="Next" />
                        }
                        else
                        {
                            <ButtonPreviuosNext ButtonEvent="OnModalRealEstateNext" ButtonName="Next" Disabled="true" />
                        }
                    }
                </div>
                <div class="right-buttons">
                    @* <ValidationMessage For=@( () => realEstateModel.RealEstateName ) /> *@
                    @* The button to submit/update form *@
                    <ButtonSave Form="realEstateForm123" />
                    <ButtonCloseCancel TextButton="Cancel" ButtonEvent="OnHideModalEditAddRealEstateClick" />
                </div>
            </div>
        </EditForm>
    </BodyTemplate>
</Modal>

@code {
    [Parameter]
    public RealEstate CurrentRealEstate { get; set; } = new();
    private IQueryable<RealEstate> _realEstatesListAsQueryable { get; set; }
    private Modal refModalEditAddRealEstate { get; set; } = new();
    private EditContext? editContext;
    private bool validRealEstate;
    public Action realEstateDataHasChanged;
    public RealEstate? realEstateModel = new();


    private async Task RealEsatateFormSubmitted(EditContext editContext)
    {
        // editContext.Field(realEstateModel.RealEstateID.ToString());
        //call form validation
        validRealEstate = editContext.Validate();
        if (validRealEstate == true)
        {
            if (CurrentRealEstate == null || CurrentRealEstate.RealEstateID == 0)
            {
                validRealEstate = editContext.Validate();
                await DataService.AddNewRealEstateToDB(CurrentRealEstate);
                // Adding to xml data file
                // DataService.AddNewRealEstateToXML(CurrentRealEstate);
            }
            else
            {
                validRealEstate = editContext.Validate();
                await DataService.UpdateObjectInDB();
            }
            realEstateDataHasChanged();
            await refModalEditAddRealEstate.HideAsync();
        }
        else
        {
            validRealEstate = editContext.Validate();
            return;
        }
    }

    private void OnModalRealEstateNext()
    {
        int CurrentRealEstateIndex = 0;
        List<RealEstate> allRealEstates = _realEstatesListAsQueryable.ToList();
        if (CurrentRealEstate != null)
        {
            CurrentRealEstateIndex = allRealEstates.IndexOf(CurrentRealEstate);
            CurrentRealEstate = allRealEstates[CurrentRealEstateIndex + 1];
            //one line code with linq
            // CurrentRealEstate = allRealEstates[(allRealEstates.IndexOf(CurrentRealEstate) + 1) % allRealEstates.Count];
        }
    }

    private void OnModalRealEstatePreviuos()
    {
        int CurrentRealEstateIndex = 0;
        List<RealEstate> allRealEstates = _realEstatesListAsQueryable.ToList();
        if (CurrentRealEstate != null)
        {
            CurrentRealEstateIndex = allRealEstates.IndexOf(CurrentRealEstate);
            CurrentRealEstate = allRealEstates[CurrentRealEstateIndex - 1];
            //one line code with linq
            // CurrentRealEstate = allRealEstates[(allRealEstates.IndexOf(CurrentRealEstate) -1) % allRealEstates.Count]
        }
    }

    public async Task OnHideModalEditAddRealEstateClick()
    {
        await refModalEditAddRealEstate.HideAsync();
    }

    public async Task OnShowModalEditAddRealEstateClick()
    {
        await refModalEditAddRealEstate.ShowAsync();
    }

    protected override void OnInitialized()
    {
        if (DataService.CurrentUserWithAllData.RealEstates == null)
        {
            _realEstatesListAsQueryable = DataService.CurrentUserWithAllData.RealEstates.DefaultIfEmpty<RealEstate>().AsQueryable();
        }
        else
        {
            _realEstatesListAsQueryable = DataService.CurrentUserWithAllData.RealEstates.ToList().AsQueryable();
        }
        editContext = new(CurrentRealEstate);
        base.OnInitialized();
    }
}
